name: auto-update-submodule
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-submodules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository (no submodules)
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0
          persist-credentials: true

      - name: Prepare git for push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Clone nicovideo4as (fallback to branch tip) and update gitlink
        run: |
          set -e
          SUBMODULE_PATH=nicovideo4as
          SUBMODULE_URL="https://github.com/NKS0131/nicovideo4as.git"
          TARGET_BRANCH=main

          # Ensure we don't rely on a possibly-missing fixed commit; clone branch tip
          rm -rf "$SUBMODULE_PATH"
          git clone --depth 1 --branch "$TARGET_BRANCH" "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/NKS0131/nicovideo4as.git" "$SUBMODULE_PATH" || \
            git clone --depth 1 "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/NKS0131/nicovideo4as.git" "$SUBMODULE_PATH"

          NEW_COMMIT=$(git -C "$SUBMODULE_PATH" rev-parse HEAD)
          echo "nicovideo4as -> $NEW_COMMIT"

          # Add the folder so the gitlink in the superproject is updated to the new commit
          git add "$SUBMODULE_PATH"

          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore: update nicovideo4as submodule to ${NEW_COMMIT}"
            git push origin HEAD
          else
            echo "No changes"
          fi

      - name: Continue pipeline
        run: echo "追加処理があればここに書く"
